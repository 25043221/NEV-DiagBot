import time
from typing import Iterator

import streamlit as st
import os
import uuid

from chat import ChatAgent
# å¯¼å…¥ create_db å’Œ query_dbã€‚query_db åœ¨ä¸»èŠå¤©æµç¨‹ä¸­æ²¡æœ‰ç›´æ¥ä½¿ç”¨ï¼Œä½†å¯èƒ½ç”¨äºå…¶ä»–è°ƒè¯•æˆ–åŠŸèƒ½ã€‚
from embed import create_db, query_db

# --- 1. é¡µé¢åŸºç¡€è®¾ç½® (é¢†åŸŸé€‚é…) ---
# è®¾ç½® Streamlit åº”ç”¨çš„é¡µé¢é…ç½®ï¼ŒåŒ…æ‹¬æ ‡é¢˜ã€å›¾æ ‡å’Œå¸ƒå±€
st.set_page_config(
    page_title="æ–°èƒ½æºæ±½è½¦æ™ºèƒ½åŠ©æ‰‹",
    page_icon="ğŸš—",
    layout="wide"
)

# --- 2. åº”ç”¨æ ‡é¢˜å’Œä»‹ç» (é¢†åŸŸé€‚é…) ---
# è®¾ç½®åº”ç”¨çš„ä¸»æ ‡é¢˜
st.title("ğŸš— æ–°èƒ½æºæ±½è½¦æ™ºèƒ½è¯Šæ–­ä¸çŸ¥è¯†åŠ©æ‰‹")
# æ·»åŠ åº”ç”¨çš„å‰¯æ ‡é¢˜/è¯´æ˜
st.caption("ç”±æœ¬åœ°å¤§æ¨¡å‹é©±åŠ¨ï¼Œä¸ºæ‚¨è§£ç­”å…³äºæ–°èƒ½æºæ±½è½¦çš„ä½¿ç”¨ã€ä¿å…»åŠæ•…éšœè¯Šæ–­é—®é¢˜ã€‚")
st.markdown("---") # æ·»åŠ ä¸€æ¡æ°´å¹³åˆ†éš”çº¿ï¼Œç”¨äºè§†è§‰ä¸Šçš„åˆ†éš”

# --- åç«¯åˆå§‹åŒ– ---

# ä½¿ç”¨ @st.cache_resource è£…é¥°å™¨ç¼“å­˜èµ„æºï¼Œé¿å…åœ¨æ¯æ¬¡åº”ç”¨é‡æ–°è¿è¡Œæ—¶é‡å¤åˆå§‹åŒ–
@st.cache_resource
def get_chat_agent():
    """åŠ è½½å¹¶ç¼“å­˜ ChatAgent å®ä¾‹"""
    print("æ­£åœ¨åˆå§‹åŒ– ChatAgent...")
    # åˆå§‹åŒ– ChatAgent å®ä¾‹ï¼ŒæŒ‡å®šOllamaæ¨¡å‹åç§°ã€‚
    # ç¡®ä¿åœ¨Ollamaä¸­å·²ä¸‹è½½å¹¶è¿è¡Œæ­¤æ¨¡å‹ã€‚
    return ChatAgent(model_name="qwen3:4B")


# ä½¿ç”¨ @st.cache_resource è£…é¥°å™¨ç¼“å­˜èµ„æºï¼Œé¿å…åœ¨æ¯æ¬¡åº”ç”¨é‡æ–°è¿è¡Œæ—¶é‡å¤æ‰§è¡Œ
@st.cache_resource
def ensure_db_created():
    """æ£€æŸ¥å¹¶åˆ›å»ºæ•°æ®åº“"""
    # æ³¨æ„ï¼šembed.py ä¸­çš„ create_db å‡½æ•°ç›®å‰ä¸æ¥å—æ–‡ä»¶è·¯å¾„å‚æ•°ã€‚
    # å®ƒä¾èµ–äº chunk.py ä¸­çš„ get_pdf_text å‡½æ•°æ¥æŸ¥æ‰¾ PDF æ–‡ä»¶ã€‚
    # åœ¨è¿™é‡Œæ£€æŸ¥ PDF æ–‡ä»¶çš„å­˜åœ¨æ€§æ˜¯ä½œä¸ºå…ˆå†³æ¡ä»¶ã€‚
    pdf_file_path = "./data/ç§¦plusDMiç”¨æˆ·æ‰‹å†Œ.pdf"
    # ä» PDF æ–‡ä»¶è·¯å¾„ä¸­æå–ç›®å½•è·¯å¾„
    data_dir = os.path.dirname(pdf_file_path)

    # æ£€æŸ¥æ•°æ®ç›®å½•æ˜¯å¦å­˜åœ¨
    if not os.path.exists(data_dir):
        st.error(f"é”™è¯¯ï¼šæ•°æ®ç›®å½• `{data_dir}` ä¸å­˜åœ¨ã€‚è¯·åˆ›å»ºè¯¥ç›®å½•å¹¶å°†ç”¨æˆ·æ‰‹å†ŒPDFæ–‡ä»¶æ”¾å…¥å…¶ä¸­ã€‚")
        return False

    # æ£€æŸ¥ç‰¹å®šçš„ PDF æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if not os.path.exists(pdf_file_path):
        st.error(f"é”™è¯¯ï¼šæœªæ‰¾åˆ°ç”¨æˆ·æ‰‹å†ŒPDFæ–‡ä»¶åœ¨è·¯å¾„ `{pdf_file_path}`. è¯·ç¡®ä¿æ–‡ä»¶å­˜åœ¨ã€‚")
        return False

    print("æ­£åœ¨æ£€æŸ¥å¹¶åˆ›å»ºæ•°æ®åº“...")
    try:
        # å°è¯•åˆ›å»º ChromaDB æ•°æ®åº“ã€‚
        # è¯·æ³¨æ„ï¼šembed.py ä¸­çš„ create_db() å†…éƒ¨è°ƒç”¨ chunk.py ä¸­çš„ get_text_chunks()ï¼Œ
        # è€Œ get_text_chunks() ç¡¬ç¼–ç äº† PDF æ–‡ä»¶çš„æŸ¥æ‰¾è·¯å¾„ï¼ˆä¾‹å¦‚ '/home/yu/zjh/my_app/data'ï¼‰ã€‚
        # è¯·ç¡®ä¿æ­¤è·¯å¾„æˆ–å…¶ç¬¦å·é“¾æ¥æŒ‡å‘æ‚¨å®é™…çš„æ•°æ®ç›®å½•ã€‚
        create_db()
        return True
    except Exception as e:
        # æ•è·åˆ›å»ºæˆ–è¿æ¥æ•°æ®åº“æ—¶å¯èƒ½å‘ç”Ÿçš„ä»»ä½•å¼‚å¸¸
        st.error(f"åˆ›å»ºæˆ–è¿æ¥æ•°æ®åº“æ—¶å‘ç”Ÿé”™è¯¯: {e}")
        return False # æŒ‡ç¤ºå¤±è´¥


# åŠ è½½ ChatAgent å®ä¾‹å¹¶ç¡®ä¿æ•°æ®åº“å·²è®¾ç½®
agent = get_chat_agent()
db_created = ensure_db_created()

# å¦‚æœæ•°æ®åº“åˆ›å»ºå¤±è´¥ï¼Œåœæ­¢ Streamlit åº”ç”¨ç¨‹åºä»¥é˜²æ­¢è¿›ä¸€æ­¥çš„é”™è¯¯
if not db_created:
    st.stop() # è¿™å°†é˜»æ­¢åº”ç”¨ç¨‹åºç»§ç»­æ‰§è¡Œï¼Œå¦‚æœæ•°æ®åº“æœªå‡†å¤‡å¥½ã€‚

# --- ä¼šè¯çŠ¶æ€ç®¡ç† ---

# æ£€æŸ¥ Streamlit ä¼šè¯çŠ¶æ€ä¸­æ˜¯å¦å­˜åœ¨å”¯ä¸€çš„ session_id
if "session_id" not in st.session_state:
    st.session_state.session_id = str(uuid.uuid4()) # ä½¿ç”¨ UUID ç”Ÿæˆå”¯ä¸€çš„ä¼šè¯ ID

# æ£€æŸ¥ä¼šè¯çŠ¶æ€ä¸­æ˜¯å¦å­˜åœ¨èŠå¤©æ¶ˆæ¯å†å²è®°å½•
if "messages" not in st.session_state:
    # ä½¿ç”¨åŠ©æ‰‹çš„å¼€åœºç™½åˆå§‹åŒ–æ¶ˆæ¯åˆ—è¡¨
    st.session_state.messages = [{"role": "assistant", "content": "æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ä¸“å±æ–°èƒ½æºæ±½è½¦åŠ©æ‰‹ã€‚è¯·é—®å…³äºæ‚¨çš„çˆ±è½¦ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿæ¯”å¦‚ï¼Œæ‚¨æœ‰ä»€ä¹ˆæ•…éšœç éœ€è¦æŸ¥è¯¢ï¼Œæˆ–è€…æƒ³äº†è§£æŸä¸ªåŠŸèƒ½ï¼Ÿ"}]


# --- 5. ä¾§è¾¹æ ä¸ç¤ºä¾‹é—®é¢˜ (æå‡ç”¨æˆ·ä½“éªŒ) ---
with st.sidebar: # æ­¤ä»£ç å—ä¸­çš„å†…å®¹å°†æ˜¾ç¤ºåœ¨ Streamlit çš„ä¾§è¾¹æ ä¸­
    st.header("ğŸ’¡ ä½¿ç”¨æç¤º")
    st.info("æ‚¨å¯ä»¥ç›´æ¥åœ¨ä¸‹æ–¹çš„èŠå¤©æ¡†ä¸­æé—®ï¼Œä¹Ÿå¯ä»¥ç‚¹å‡»ä¸‹é¢çš„ç¤ºä¾‹é—®é¢˜ï¼Œå¿«é€Ÿå¼€å§‹ä½“éªŒã€‚")

    st.subheader("â“ å¸¸ç”¨é—®é¢˜ç¤ºä¾‹")
    # å®šä¹‰ä¸€ä¸ªç¤ºä¾‹é—®é¢˜åˆ—è¡¨ï¼Œæ–¹ä¾¿ç”¨æˆ·å¿«é€Ÿäº¤äº’
    example_questions = [
        "æˆ‘çš„è½¦æœ€è¿‘ç»­èˆªæ‰äº†20%ï¼Œå¯èƒ½æ˜¯ä»€ä¹ˆåŸå› ï¼Ÿ",
        "å¦‚ä½•ä¸ºæˆ‘çš„è½¦è¾†è¿›è¡Œé¦–æ¬¡ä¿å…»ï¼Ÿ",
        "ä»ªè¡¨ç›˜ä¸Šå‡ºç°ä¸€ä¸ªé»„è‰²çš„ç”µæ± å›¾æ ‡æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ",
        "ç©ºè°ƒåˆ¶å†·æ•ˆæœä¸ä½³æ€ä¹ˆåŠï¼Ÿ",
        "P0420æ•…éšœç æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ",
        "å†¬å­£å¦‚ä½•ç»´æŠ¤ç”µæ± ï¼Ÿ",
        "æœ€è¿‘ç”µåŠ¨æ±½è½¦è‡ªç‡ƒäº‹ä»¶å¤šå‘ï¼Œæˆ‘çš„è½¦å®‰å…¨å—ï¼Ÿ"
    ]

    selected_question = None # åˆå§‹åŒ–ä¸€ä¸ªå˜é‡ï¼Œç”¨äºå­˜å‚¨ä»æŒ‰é’®ä¸­é€‰æ‹©çš„é—®é¢˜
    for q in example_questions:
        if st.button(q, key=q): # ä¸ºæ¯ä¸ªç¤ºä¾‹é—®é¢˜åˆ›å»ºä¸€ä¸ªæŒ‰é’®
            selected_question = q # å¦‚æœæŒ‰é’®è¢«ç‚¹å‡»ï¼Œåˆ™è®¾ç½® selected_question

    st.subheader("ğŸ› ï¸ æ•…éšœç å¿«é€ŸæŸ¥è¯¢")
    # ç”¨äºç”¨æˆ·è¾“å…¥æ•…éšœç çš„æ–‡æœ¬è¾“å…¥æ¡†
    st.text_input("åœ¨è¿™é‡Œè¾“å…¥æ•…éšœç  (å¦‚ P0420)", key="fault_code_input",
                   placeholder="ä¾‹å¦‚ï¼šP0420")
    # å¦‚æœæ•…éšœç è¾“å…¥æ¡†ä¸­æœ‰å†…å®¹
    if st.session_state.fault_code_input:
        if st.button("æŸ¥è¯¢æ•…éšœç "): # è§¦å‘æ•…éšœç æŸ¥è¯¢çš„æŒ‰é’®
            # å°†è¾“å…¥æ ¼å¼åŒ–ä¸ºèŠå¤©æœºå™¨äººå¯è¯†åˆ«çš„é—®é¢˜
            selected_question = st.session_state.fault_code_input + "æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ"
            st.session_state.fault_code_input = "" # é€‰æ‹©åæ¸…ç©ºè¾“å…¥å­—æ®µï¼Œé¿å…é‡å¤è§¦å‘


    st.markdown("---")
    st.header("ğŸ§  å‚è€ƒä¸Šä¸‹æ–‡")
    # ä¸€ä¸ªå®¹å™¨ï¼Œç”¨äºåŠ¨æ€æ˜¾ç¤ºæ£€ç´¢åˆ°çš„ä¸Šä¸‹æ–‡å’Œæ¥æºä¿¡æ¯
    st.session_state.source_container = st.container()

    st.markdown("---")
    st.header("âš™ï¸ æ›´å¤šåŠŸèƒ½ (è§„åˆ’ä¸­)")
    st.info("æœªæ¥ç‰ˆæœ¬å°†æ”¯æŒï¼š")
    st.markdown("""
        * å®æ—¶è½¦è¾†æ•°æ®è¯Šæ–­ï¼šè¿æ¥OBDæ¥å£ï¼Œå®æ—¶ç›‘æµ‹è½¦è¾†å¥åº·çŠ¶å†µã€‚
        * è¯­éŸ³äº¤äº’ï¼šæ›´è‡ªç„¶çš„å¯¹è¯ä½“éªŒã€‚
        * å›¾åƒè¯†åˆ«ï¼šæ‹ç…§è¯†åˆ«ä»ªè¡¨ç›˜è­¦å‘Šç¯ï¼Œç›´è§‚è·å–ä¿¡æ¯ã€‚
        * ä¸“ä¸šæŠ€å¸ˆé¢„çº¦/ç¤¾åŒºäº’åŠ©ï¼šä¸€é”®è”ç³»ä¸“ä¸šæœåŠ¡æˆ–è·å–è½¦å‹å¸®åŠ©ã€‚
        * è§†é¢‘æ•™ç¨‹åº“ï¼šæä¾›å¸¸è§ä¿å…»å’Œç®€å•ç»´ä¿®çš„è§†é¢‘æŒ‡å¯¼ã€‚
    """)


# --- 6. èŠå¤©ç•Œé¢æ¸²æŸ“ (ä¿æŒä¸å˜) ---
# éå†ä¼šè¯çŠ¶æ€ä¸­å­˜å‚¨çš„æ¶ˆæ¯å¹¶æ˜¾ç¤ºå®ƒä»¬
for message in st.session_state.messages:
    with st.chat_message(message["role"]): # ä½¿ç”¨ Streamlit çš„ chat_message ç»„ä»¶
        st.markdown(message["content"]) # å°†æ¶ˆæ¯å†…å®¹ä½œä¸º Markdown æ ¼å¼æ˜¾ç¤º



# --- 7. ç”¨æˆ·è¾“å…¥å¤„ç†ä¸ RAG æµç¨‹ (æ ¸å¿ƒé‡æ„) ---

# æ£€æŸ¥æ˜¯å¦æœ‰é€šè¿‡èŠå¤©è¾“å…¥æ¡†æˆ–ç¤ºä¾‹é—®é¢˜/æ•…éšœç æä¾›çš„æç¤º
if prompt := selected_question or st.chat_input("è¯·åœ¨è¿™é‡Œæè¿°æ‚¨çš„é—®é¢˜..."):
    # å°†ç”¨æˆ·çš„æé—®æ·»åŠ åˆ°ä¼šè¯çŠ¶æ€ä¸­çš„èŠå¤©å†å²è®°å½•
    st.session_state.messages.append({"role": "user", "content": prompt})
    # åœ¨èŠå¤©ç•Œé¢ä¸­æ˜¾ç¤ºç”¨æˆ·çš„æé—®
    with st.chat_message("user"):
        st.markdown(prompt)

    # å‡†å¤‡åŠ©æ‰‹çš„å›å¤
    with st.chat_message("assistant"):
        with st.spinner("æ­£åœ¨çŸ¥è¯†åº“ä¸­æ£€ç´¢å¹¶æ€è€ƒ..."): # æ˜¾ç¤ºä¸€ä¸ªæ—‹è½¬åŠ¨ç”»ï¼Œè¡¨ç¤ºæ­£åœ¨å¤„ç†
            try:
                # è°ƒç”¨ RAG æ ¸å¿ƒæµç¨‹ï¼ˆChatAgent çš„ rag_chat æ–¹æ³•ï¼‰
                # ä¼ é€’ç”¨æˆ·çš„æé—®ã€å½“å‰çš„ session_id å’Œæ‰€éœ€çš„ç»“æœæ•°é‡
                response_data = agent.rag_chat(prompt, session_id=st.session_state.session_id, n_results=5)
                # ä»å“åº”æ•°æ®ä¸­æå–ä¸Šä¸‹æ–‡æ–‡æ¡£å’Œæ¥æºä¿¡æ¯
                context_docs = response_data.get("context", [])
                sources = response_data.get("sources", [])

                # åœ¨ä¾§è¾¹æ çš„ä¸“ç”¨å®¹å™¨ä¸­æ˜¾ç¤ºä¸Šä¸‹æ–‡å’Œæ¥æºä¿¡æ¯
                with st.session_state.source_container:
                    if not context_docs:
                        st.warning("æœªèƒ½ä»çŸ¥è¯†åº“ä¸­æ‰¾åˆ°ç›´æ¥ç›¸å…³çš„ä¿¡æ¯ã€‚æ¨¡å‹çš„å›ç­”å°†åŸºäºå…¶é€šç”¨çŸ¥è¯†æˆ–ç½‘ç»œæœç´¢ã€‚")
                    else:
                        st.info("ä»¥ä¸‹æ˜¯æœ¬æ¬¡å›ç­”å‚è€ƒçš„ä¸»è¦çŸ¥è¯†ç‰‡æ®µï¼š")
                        # éå†å¹¶æ˜¾ç¤ºæ¯ä¸ªæ£€ç´¢åˆ°çš„æ–‡æ¡£ç‰‡æ®µ
                        for i, doc in enumerate(context_docs):
                            with st.expander(f"å‚è€ƒæ–‡æ¡£ {i + 1}"): # ä½¿ç”¨å¯æŠ˜å çš„æ‰©å±•å™¨ï¼Œæ–¹ä¾¿æŸ¥çœ‹
                                # æ˜¾ç¤ºæ–‡æ¡£çš„å‰ 500 ä¸ªå­—ç¬¦ï¼Œå¦‚æœæ–‡æ¡£è¾ƒçŸ­åˆ™æ˜¾ç¤ºå…¨éƒ¨
                                st.text(doc[:500] + "..." if len(doc) > 500 else doc)
                        if sources:
                            st.markdown("---")
                            st.info("æ¥æºä¿¡æ¯:")
                            for source in sources:
                                st.markdown(f"- {source}")
                        else:
                            # ç†è®ºä¸Šï¼Œå¦‚æœæ‰¾åˆ°äº†ä¸Šä¸‹æ–‡æ–‡æ¡£ï¼Œè¿™é‡Œä¸åº”è¯¥å‡ºç°â€œæ— æ˜ç¡®æ¥æºä¿¡æ¯â€çš„æƒ…å†µ
                            st.markdown("---")
                            st.warning("æ— æ˜ç¡®æ¥æºä¿¡æ¯ã€‚")

                # ä» Agent çš„å“åº”æ•°æ®ä¸­è·å–æœ€ç»ˆçš„å›ç­”
                full_response = response_data.get("answer", "æ— æ³•è·å–å›ç­”ã€‚")

            except Exception as e:
                # æ•è·å¤„ç†è¿‡ç¨‹ä¸­å¯èƒ½å‘ç”Ÿçš„ä»»ä½•å¼‚å¸¸ï¼Œå¹¶æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                st.error(f"å¤„ç†é—®é¢˜æ—¶å‡ºé”™: {e}")
                full_response = "æŠ±æ­‰ï¼Œæˆ‘åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚æ—¶é‡åˆ°äº†é—®é¢˜ã€‚è¯·ç¨åå†è¯•ã€‚"

        st.write(full_response) # æ˜¾ç¤ºåŠ©æ‰‹çš„æœ€ç»ˆå›ç­”
    # å°†åŠ©æ‰‹çš„å›ç­”æ·»åŠ åˆ°ä¼šè¯çŠ¶æ€ä¸­çš„èŠå¤©å†å²è®°å½•
    st.session_state.messages.append({"role": "assistant", "content": full_response})